*&---------------------------------------------------------------------*
*& Report ZDATASET
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
REPORT ZVIM_PO01.
TABLES : EKKO.

INCLUDE ZVIM_01.


SELECT-OPTIONS :
  P_BUKRS FOR EKKO-BUKRS DEFAULT '1000',
  P_EBELN FOR EKKO-EBELN,
  P_LIFNR FOR EKKO-LIFNR,
  P_CPUDT FOR EKKO-AEDAT.

REFRESH: LT_PO, LT_EKKO, LT_EKPO, LT_EKBE, LT_MATDOC, LT_MARA.

SELECT * INTO TABLE LT_PO FROM ZVPO01
  WHERE BUKRS IN P_BUKRS AND
        EBELN IN P_EBELN AND
        LIFNR IN P_LIFNR AND
        BEDAT IN P_CPUDT.
*        AND WEMNG > 0.

IF LT_PO[] IS NOT INITIAL.

  SELECT * INTO CORRESPONDING FIELDS OF TABLE LT_EKKO
    FROM EKKO FOR ALL ENTRIES IN LT_PO
      WHERE EBELN = LT_PO-EBELN.

  SELECT * INTO CORRESPONDING FIELDS OF TABLE LT_EKPO
    FROM EKPO FOR ALL ENTRIES IN LT_PO
      WHERE EBELN = LT_PO-EBELN.

  SELECT * INTO CORRESPONDING FIELDS OF TABLE LT_MATDOC
    FROM MATDOC FOR ALL ENTRIES IN LT_PO
      WHERE EBELN = LT_PO-EBELN AND BWART = '101'
        AND XAUTO = ''.

  SELECT * INTO CORRESPONDING FIELDS OF TABLE LT_LFA1 FROM LFA1
    FOR ALL ENTRIES IN LT_PO
      WHERE LIFNR = LT_PO-LIFNR.

  SELECT * INTO CORRESPONDING FIELDS OF TABLE LT_EKBE
    FROM EKBE FOR ALL ENTRIES IN LT_PO
      WHERE EBELN = LT_PO-EBELN AND VGABE <> '1'.

  SELECT * INTO CORRESPONDING FIELDS OF TABLE LT_MARA
    FROM MARA INNER JOIN MAKT ON MARA~MATNR = MAKT~MATNR
      FOR ALL ENTRIES IN LT_PO
        WHERE MARA~MATNR = LT_PO-MATNR AND MAKT~SPRAS = 'EN'.

  SORT LT_EKKO BY EBELN.
  SORT LT_EKPO BY EBELN EBELP.

  DATA: FILE      TYPE STRING, " VALUE '/spare/sapreport/ZMCHB.TXT',
        RESULT    TYPE STRING,
        JSON_DATA TYPE STRING,
        V_TMP     TYPE STRING.
  FIELD-SYMBOLS <FS> TYPE ANY.



  "Purchase Order
  FILE = '/usr/sap/vimec/upload/vimec_openpo.txt'.
  OPEN DATASET FILE FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
  LOOP AT LT_PO.
    CLEAR: RESULT.
    DO.
      ASSIGN COMPONENT SY-INDEX OF
             STRUCTURE LT_PO TO <FS>.
      IF SY-SUBRC <> 0.
        EXIT.
      ENDIF.
      V_TMP = <FS>.
      CONCATENATE RESULT V_TMP TAB INTO RESULT.
    ENDDO.

    TRANSFER RESULT TO FILE.
  ENDLOOP.
  CLOSE DATASET FILE.

  "PO Header
  CLEAR JSON_DATA.
  FILE = '/usr/sap/vimec/upload/vimec_ekko.json'.
  OPEN DATASET FILE FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
*    JSON_DATA = /UI2/CL_JSON=>SERIALIZE( DATA = LT_EKKO[] COMPRESS = ABAP_TRUE PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE ).
  JSON_DATA = /UI2/CL_JSON=>SERIALIZE( DATA = LT_EKKO[] ASSOC_ARRAYS = ABAP_TRUE PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE ).
  TRANSFER JSON_DATA TO FILE.
  CLOSE DATASET FILE.

  FILE = '/usr/sap/vimec/upload/vimec_ekko.txt'.
  OPEN DATASET FILE FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
  LOOP AT LT_EKKO.
    CLEAR: RESULT.
    DO.
      ASSIGN COMPONENT SY-INDEX OF
             STRUCTURE LT_EKKO TO <FS>.
      IF SY-SUBRC <> 0.
        EXIT.
      ENDIF.
      V_TMP = <FS>.
      CONCATENATE RESULT V_TMP TAB INTO RESULT.
    ENDDO.

    TRANSFER RESULT TO FILE.
  ENDLOOP.
  CLOSE DATASET FILE.

  FILE = '/usr/sap/vimec/upload/vimec_ekko_h.csv'.
  OPEN DATASET FILE FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
  LOOP AT LT_EKKO.
    CLEAR: RESULT.
    DO.
      ASSIGN COMPONENT SY-INDEX OF
             STRUCTURE LT_EKKO TO <FS>.
      IF SY-SUBRC <> 0.
        EXIT.
      ENDIF.
      V_TMP = <FS>.
      CONCATENATE RESULT V_TMP TAB INTO RESULT.
    ENDDO.

    TRANSFER RESULT TO FILE.
  ENDLOOP.
  CLOSE DATASET FILE.

  "PO Items
  CLEAR JSON_DATA.
  FILE = '/usr/sap/vimec/upload/vimec_ekpo.json'.
  OPEN DATASET FILE FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
*    JSON_DATA = /UI2/CL_JSON=>SERIALIZE( DATA = LT_EKKO[] COMPRESS = ABAP_TRUE PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE ).
  JSON_DATA = /UI2/CL_JSON=>SERIALIZE( DATA = LT_EKPO[] ASSOC_ARRAYS = ABAP_TRUE PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE ).
  TRANSFER JSON_DATA TO FILE.
  CLOSE DATASET FILE.

  FILE = '/usr/sap/vimec/upload/vimec_ekpo.txt'.
  OPEN DATASET FILE FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
  LOOP AT LT_EKPO.
    CLEAR: RESULT.
    DO.
      ASSIGN COMPONENT SY-INDEX OF
             STRUCTURE LT_EKPO TO <FS>.
      IF SY-SUBRC <> 0.
        EXIT.
      ENDIF.
      V_TMP = <FS>.
      CONCATENATE RESULT V_TMP TAB INTO RESULT.
    ENDDO.

    TRANSFER RESULT TO FILE.
  ENDLOOP.
  CLOSE DATASET FILE.

  "GR Data
  CLEAR JSON_DATA.
  FILE = '/usr/sap/vimec/upload/vimec_matdoc.json'.
  OPEN DATASET FILE FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
  JSON_DATA = /UI2/CL_JSON=>SERIALIZE( DATA = LT_MATDOC[] ASSOC_ARRAYS = ABAP_TRUE PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE ).
  TRANSFER JSON_DATA TO FILE.
  CLOSE DATASET FILE.

  FILE = '/usr/sap/vimec/upload/vimec_gr.txt'.
  OPEN DATASET FILE FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
  LOOP AT LT_MATDOC.
    IF LT_MATDOC-WAERS = 'IDR'.
      LT_MATDOC-DMBTR = LT_MATDOC-DMBTR * 100.
    ENDIF.
    CLEAR: RESULT.
    DO.
      ASSIGN COMPONENT SY-INDEX OF
             STRUCTURE LT_MATDOC TO <FS>.
      IF SY-SUBRC <> 0.
        EXIT.
      ENDIF.


      V_TMP = <FS>.
      CONCATENATE RESULT V_TMP TAB INTO RESULT.
    ENDDO.

    TRANSFER RESULT TO FILE.
  ENDLOOP.
  CLOSE DATASET FILE.

  "Vendor
  CLEAR JSON_DATA.
  FILE = '/usr/sap/vimec/upload/vimec_vendor.json'.
  OPEN DATASET FILE FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
*    JSON_DATA = /UI2/CL_JSON=>SERIALIZE( DATA = LT_EKKO[] COMPRESS = ABAP_TRUE PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE ).
  JSON_DATA = /UI2/CL_JSON=>SERIALIZE( DATA = LT_LFA1[] ASSOC_ARRAYS = ABAP_TRUE PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE ).
  TRANSFER JSON_DATA TO FILE.
  CLOSE DATASET FILE.

  FILE = '/usr/sap/vimec/upload/vimec_vendor.txt'.
  OPEN DATASET FILE FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
  LOOP AT LT_LFA1.
    CLEAR: RESULT.
    DO.
      ASSIGN COMPONENT SY-INDEX OF
             STRUCTURE LT_LFA1 TO <FS>.
      IF SY-SUBRC <> 0.
        EXIT.
      ENDIF.
      V_TMP = <FS>.
      CONCATENATE RESULT V_TMP TAB INTO RESULT.
    ENDDO.

    TRANSFER RESULT TO FILE.
  ENDLOOP.
  CLOSE DATASET FILE.

  "Purchase Order History
  CLEAR JSON_DATA.
  FILE = '/usr/sap/vimec/upload/vimec_ekbe.json'.
  OPEN DATASET FILE FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
  JSON_DATA = /UI2/CL_JSON=>SERIALIZE( DATA = LT_EKBE[] ASSOC_ARRAYS = ABAP_TRUE PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE ).
  TRANSFER JSON_DATA TO FILE.
  CLOSE DATASET FILE.

  "Material Master
  CLEAR JSON_DATA.
  FILE = '/usr/sap/vimec/upload/vimec_mara.json'.
  OPEN DATASET FILE FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
  JSON_DATA = /UI2/CL_JSON=>SERIALIZE( DATA = LT_MARA[] ASSOC_ARRAYS = ABAP_TRUE PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE ).
  TRANSFER JSON_DATA TO FILE.
  CLOSE DATASET FILE.
ENDIF.
